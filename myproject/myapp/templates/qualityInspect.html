{% extends "base.html" %}
{% block title %}SMART AI FACTORY{% endblock %}
{% block content %}
<div class="navigation w-100 h-100">
    <div class="left h-100 d-inline-block">
        {% include "layout/menu.html" %}
    </div>

    <div class="contain_box">
        <div class="top_box">
            {% include "layout/title.html" %}
        </div>
        <div class="center_box_02_01">
            <div class="item02" style="overflow: hidden;">
                <div class="notosans400 fons13" style="display: flex; align-items: center; justify-content: space-between;">
                  <div class="color_black">HD-1500-00 실시간</div>
                  <div>
                    <button type="button" class="btn btn-dark btn-sm notosans400" style="font-size: 11px;" id="weeklyBtn">주간</button>
                    <button type="button" class="btn btn-light btn-sm notosans400" style="font-size: 11px;" id="monthlyBtn">월간</button>
                    <button type="button" class="btn btn-light btn-sm notosans400" style="font-size: 11px;" id="yearlyBtn">년간</button>
                  </div> 

                </div>
                <div class="map_box" style="padding: 10px 20px; display: flex; justify-content: center;">
                    <canvas id="myChart01" width="1150" height="270"></canvas>
                    <!-- <img src=".\img\005.png" style="height:100%;"/> -->
                </div>
            </div>
            <div class="item01">
                <div class="notosans400 fons13 color_black">품질 비율</div>
                <div class="map_box" style="padding: 10px 70px">
                    <canvas id="myChart02" width="270" height="270"></canvas>
                </div>
            </div>
        </div>
            <div class="card" style="margin: 0 20px;">
                <div class="card-body">
                    <p class="notosans400 fons13 color_black">작업현황</p>
                    <div class="navigation" style="justify-content: space-between;">
                        <div style="width: 100%; height: 370px;  display: flex; align-items: flex-start; justify-content: space-between; gap:20px;">
                            <table class="table table-striped table-hover fons14 txt_cen">
                                <thead>
                                  <tr style="border-top: 1px solid #eee;">
                                    <th scope="col">No</th>
                                    <th scope="col">검출시간</th>
                                    <th scope="col">품질측정(mm/RPM)</th>
                                    <th scope="col">고객사</th>
                                    <th scope="col">사진</th>
                                  </tr>
                                </thead>
                                <tbody id="imageTable" class="cursor">
                                </tbody>
                            </table>
                            <div id="imageTable" style=" width: 510px; height: 355px; overflow: hidden; background-color: #eee; border-radius: 5px;">
                              <img id="displayedImage" src="" style="width: 100%; height: 100%;" />
                            </div>
                        </div>
                        
                    </div>
                    <div aria-label="Page navigation example">
                      <ul class="pagination pagination-sm justify-content-center" id="pagination">
                        <li class="page-item">
                          <a class="page-link" href="#" aria-label="Previous" onclick="changePage('prev')">
                            <span aria-hidden="true">&laquo;</span>
                          </a>
                        </li>
                        <li class="page-item"><a class="page-link active" href="#" onclick="changePage(1)">1</a></li>
                        <li class="page-item"><a class="page-link" href="#" onclick="changePage(2)">2</a></li>
                        <li class="page-item"><a class="page-link" href="#" onclick="changePage(3)">3</a></li>
                        <li class="page-item">
                          <a class="page-link" href="#" aria-label="Next" onclick="changePage('next')">
                            <span aria-hidden="true">&raquo;</span>
                          </a>
                        </li>
                      </ul>
                    </div>
                </div>
            </div>
            {% include "layout/foot.html" %}
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  setActiveMenu(2)
  // URL에서 쿼리 문자열을 가져옴
  const queryStr = window.location.search  
  const params = new URLSearchParams(queryStr)  
  const imageUrl = params.get("img");
  displayImage(imageUrl);

  if (imageUrl) {
    console.log("Image URL: ", imageUrl);

    let img = document.createElement('img');
    img.src = imageUrl;
  } else {
    console.log("No Image URL found.");
  }


 // Initialize pagination and data
  const rowsPerPage = 7;
  let currentPage = 1;
  let jsonData = [];

  // Fetch data asynchronously
  function fetchData(url) {
    fetch(url)
      .then(response => response.json())
      .then(data => {
        jsonData = data;
        displayTable(jsonData, currentPage, rowsPerPage);
        setupPagination(jsonData.length, rowsPerPage);
        if (jsonData.length > 0) {
          displayImage(jsonData[0].image_url);
        }
      })
      .catch(error => console.error("Error fetching data:", error));
  }

  // Load initial data
  fetchData("http://127.0.0.1:8000/test01week");

  // // window.onload = function() {
  // let xhr = new XMLHttpRequest();
  // let url = "http://127.0.0.1:8000/test01week";  // URL 수정

  // xhr.open("GET", url, true);
  // xhr.onload = function() {
  //   if (xhr.readyState === 4 && xhr.status === 200) {
  //     jsonData = JSON.parse(xhr.response);
  //     displayTable(jsonData, currentPage, rowsPerPage);
  //     setupPagination(jsonData.length, rowsPerPage);
  //     // 데이터가 있는 경우 첫 번째 이미지를 표시합니다.
  //     if (jsonData.length > 0) {
  //       displayImage(jsonData[0].image_url);
  //     }
  //   } else {
  //     console.log("Error");
  //   }
  // };
  // xhr.send();
  // // };

   // Display data in table
   function displayTable(data, page, rows) {
    const tableBody = document.getElementById('imageTable');
    tableBody.innerHTML = "";
    const start = (page - 1) * rows;
    const paginatedItems = data.slice(start, start + rows);

    paginatedItems.forEach(item => {
      const row = tableBody.insertRow();
      row.insertCell(0).innerText = item.id;
      row.insertCell(1).innerText = item.Detection_Time;
      row.insertCell(2).innerText = item.Pull_Measurement;
      row.insertCell(3).innerText = item.coustomer;

      const imgCell = row.insertCell(4);
      const img = document.createElement('img');
      img.src = item.image_url;
      img.width = 50;
      imgCell.appendChild(img);

      row.onclick = () => displayImage(item.image_url);
    });
  }

  function setupPagination(totalItems, rows) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = `
      <a class="page-link" href="#" aria-label="Previous" onclick="changePage('prev')">
        <span aria-hidden="true">&laquo;</span>
      </a>
    `;
    let pageCount = Math.ceil(totalItems / rows);
    for (let i = 1; i <= pageCount; i++) {
      pagination.innerHTML += `
        <a href="#" ${i !== currentPage ? 'class="page-link"' : 'class="page-link active'} onclick="changePage(${i})">${i}</a>
      `
      
    }
    pagination.innerHTML += `
      <a class="page-link" href="#" aria-label="Next" onclick="changePage('next')">
        <span aria-hidden="true">&raquo;</span>
      </a>
    `;
  }

  function changePage(page) {
    if (page === 'prev') {
      if (currentPage > 1) {
        currentPage--;
      }
    } else if (page === 'next') {
      if (currentPage < Math.ceil(jsonData.length / rowsPerPage)) {
        currentPage++;
      }
    } else {
      currentPage = page;
    }
    displayTable(jsonData, currentPage, rowsPerPage);
    setupPagination(jsonData.length, rowsPerPage);

    // 새 페이지의 첫 번째 이미지 표시
    if (jsonData.length > 0) {
      displayImage(jsonData[(currentPage - 1) * rowsPerPage].image_url);
    }
  }

  // function displayImage(imageUrl) {
  //   const displayedImage = document.getElementById('displayedImage');
  //   displayedImage.src = imageUrl;
  // }

 ///////////////////////
  // Display selected image
  function displayImage(imageUrl) {
    document.getElementById('displayedImage').src = imageUrl;
  }

// Fetch line chart data
function fetchChartData(url, type) {
    fetch(url)
      .then(response => response.json())
      .then(data => {
        let labels = [];
        let counts = [];

        if (type === 'weekly') {
          const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
          labels = daysOfWeek;
          counts = daysOfWeek.map(day => data.filter(item => new Date(item.Detection_Time).toLocaleDateString('en-US', { weekday: 'long' }) === day).length);
        } else if (type === 'monthly') {
          const daysOfMonth = Array.from({ length: 31 }, (_, i) => i + 1);
          labels = daysOfMonth;
          counts = daysOfMonth.map(day => data.filter(item => new Date(item.Detection_Time).getDate() === day).length);
        } else if (type === 'yearly') {
          const monthsOfYear = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
          labels = monthsOfYear;
          counts = monthsOfYear.map(month => data.filter(item => new Date(item.Detection_Time).toLocaleDateString('en-US', { month: 'long' }) === month).length);
        }

        // Update line chart
        const ctx = document.getElementById('myChart01').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: '생산량 대비 뷸량률 그래프',
              data: counts,
              backgroundColor: 'rgba(245, 40, 145, 0.8)',
              borderColor: 'rgba(245, 40, 145, 0.8)',
              borderWidth: 3
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      })
      .catch(error => console.error('Error fetching chart data:', error));
  }

  // Add event listeners to buttons
  document.getElementById('weeklyBtn').addEventListener('click', () => fetchChartData('http://127.0.0.1:8000/test01week', 'weekly'));
  document.getElementById('monthlyBtn').addEventListener('click', () => fetchChartData('http://127.0.0.1:8000/test01month', 'monthly'));
  document.getElementById('yearlyBtn').addEventListener('click', () => fetchChartData('http://127.0.0.1:8000/test01year', 'yearly'));

  // Initial line chart load
  fetchChartData('http://127.0.0.1:8000/test01week', 'weekly');

  // Fetch doughnut chart data and initialize chartㄴ
fetch('http://127.0.0.1:8000/api/chart-data/')
  .then(response => {
    console.log('API response received:', response); // Log the response object
    return response.json();
  })
  .then(data => {
    console.log('Parsed JSON data:', data); 
    if (data.defective !== undefined && data.normal !== undefined) {
      const ctx = document.getElementById('myChart02').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['불량', '정상'], 
          datasets: [{
            label: 'Quality Ratio',
            data: [data.defective, data.normal],
            backgroundColor: [
              'rgba(255, 99, 132, 0.2)',
              'rgba(75, 192, 192, 0.2)' 
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(75, 192, 192, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: '불량 vs 정상 비율' // Title in Korean
            }
          }
        },
      });
    } else {
      console.error('Unexpected data format:', data);
    }
  })
  .catch(error => console.error('Error fetching doughnut chart data:', error));
</script>

{% endblock %}
