{% extends "base.html" %}
{% block title %}SMART AI FACTORY{% endblock %}
{% block content %}
<div class="navigation w-100 h-100">
    <div class="left h-100 d-inline-block">
        {% include "layout/menu.html" %}
    </div>

    <div class="contain_box">
        <div class="top_box">
            {% include "layout/title.html" %}
        </div>
        <div class="center_box_02_01">
            <div class="item02" style="overflow: hidden;">
                <div class="notosans400 fons13" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px;">
                    <div class="color_black">실시간</div>
                    <div>
                      <button type="button" class="btn btn-light btn-sm notosans400" style="font-size: 11px;" id="daylyBtn">일간</button>
                      <button type="button" class="btn btn-dark btn-sm notosans400" style="font-size: 11px;" id="weeklyBtn">주간</button>
                      <button type="button" class="btn btn-light btn-sm notosans400" style="font-size: 11px;" id="MonthlyBtn">월간</button>
                      <button type="button" class="btn btn-light btn-sm notosans400" style="font-size: 11px;" id="yearlyBtn">년간</button>
                    </div> 
                </div>
                <div id="charbox" class="map_box" style="padding: 10px 20px; display: flex; justify-content: center;">
                    <canvas id="myChart01" width="1150" height="270"></canvas>
                </div>
            </div>
            <div class="item01">
                <div class="notosans400 fons13 color_black">품질 비율</div>
                <div id="charbox" class="map_box" style="padding: 10px 70px; margin-top: 12px;">
                    <canvas id="myChart02" width="270" height="270"></canvas>
                </div>
            </div>            
        </div>
        <div class="card" style="margin: 0 20px;">
            <div class="card-body">
                <p class="notosans400 fons13 color_black">작업현황</p>
                <div class="navigation" style="justify-content: space-between;">
                    <div style="width: 100%; height: 370px; display: flex; align-items: flex-start; justify-content: space-between; gap:20px;">
                        <table class="table table-striped table-hover fons14 txt_cen">
                            <thead>
                                <tr style="border-top: 1px solid #eee;">
                                    <th scope="col">No</th>
                                    <th scope="col">검출시간</th>
                                    <th scope="col">불량종류</th>
                                    <th scope="col">품질측정(mm/RPM)</th>
                                    <th scope="col">창고위치</th>
                                    <th scope="col">사진</th>
                                </tr>
                            </thead>
                            <tbody id="imageTable" class="cursor">
                            </tbody>
                        </table>
                        <div id="imageDisplay" style="width: 510px; height: 355px; overflow: hidden; background-color: #eee; border-radius: 5px;">
                            <img id="displayedImage" src="" style="width: 100%; height: 100%;" />
                        </div>
                    </div>
                </div>
                <div aria-label="Page navigation example">
                    <ul class="pagination pagination-sm justify-content-center" id="pagination">
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Previous" onclick="changePage('prev')">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item"><a class="page-link active" href="#" onclick="changePage(1)">1</a></li>
                        <li class="page-item"><a class="page-link" href="#" onclick="changePage(2)">2</a></li>
                        <li class="page-item"><a class="page-link" href="#" onclick="changePage(3)">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Next" onclick="changePage('next')">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        {% include "layout/foot.html" %}
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    setActiveMenu(2);

    const queryStr = window.location.search;
    const params = new URLSearchParams(queryStr);
    const imageUrl = params.get("img");
    displayImage(imageUrl);

    
    if (imageUrl) {
        console.log("Image URL: ", imageUrl);
    } else {
        console.log("No Image URL found.");
    }

    const rowsPerPage = 7;
    let currentPage = 1;
    let jsonData = [];

    function fetchData(url) {
        fetch(url)
            .then(response => response.json())
            .then(data => {
                jsonData = data;
                displayTable(jsonData, currentPage, rowsPerPage);
                setupPagination(jsonData.length, rowsPerPage);
                if (jsonData.length > 0) {
                    displayImage(jsonData[0].image_url);
                }
            })
            .catch(error => console.error("Error fetching data:", error));
    }

    fetchData("http://127.0.0.1:8000/test01week");
   

    function displayTable(data, page, rows) {
    const tableBody = document.getElementById('imageTable');
    tableBody.innerHTML = "";

    // id 필드를 기준으로 내림차순 정렬합니다.
    const sortedData = data.sort((a, b) => b.id - a.id);

    // 정상 A 카테고리를 제외한 데이터만 필터링합니다.
    const filteredData = sortedData.filter(item => item.category !== '출하 창고');

    const start = (page - 1) * rows;
    const paginatedItems = filteredData.slice(start, start + rows);

    paginatedItems.forEach(item => {
        const row = tableBody.insertRow();
        row.insertCell(0).innerText = item.id;
        row.insertCell(1).innerText = item.Detection_Time;
        row.insertCell(2).innerText = item.defect_types;
        row.insertCell(3).innerText = item.Pull_Measurement;
        row.insertCell(4).innerText = item.category;
        
        const imgCell = row.insertCell(5);
        const img = document.createElement('img');
        img.src = item.image_url;       
        img.width = 50;
        imgCell.appendChild(img);
        
        row.onclick = () => displayImage(item.image_url);
    }); 
}

    function setupPagination(totalItems, rows) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = `
            <a class="page-link" href="#" aria-label="Previous" onclick="changePage('prev')">
                <span aria-hidden="true">&laquo;</span>
            </a>
        `;
        let pageCount = Math.ceil(totalItems / rows);
        for (let i = 1; i <= pageCount; i++) {
            pagination.innerHTML += `
                <a href="#" ${i !== currentPage ? 'class="page-link"' : 'class="page-link active"'} onclick="changePage(${i})">${i}</a>
            `;
        }
        pagination.innerHTML += `
            <a class="page-link" href="#" aria-label="Next" onclick="changePage('next')">
                <span aria-hidden="true">&raquo;</span>
            </a>
        `;
    }

    function changePage(page) {
        if (page === 'prev') {
            if (currentPage > 1) {
                currentPage--;
            }
        } else if (page === 'next') {
            if (currentPage < Math.ceil(jsonData.length / rowsPerPage)) {
                currentPage++;
            }
        } else {
            currentPage = page;
        }
        displayTable(jsonData, currentPage, rowsPerPage);
        setupPagination(jsonData.length, rowsPerPage);

        if (jsonData.length > 0) {
            displayImage(jsonData[(currentPage - 1) * rowsPerPage].image_url);
        }
    }

    function displayImage(image_url) {
        const displayedImage = document.getElementById('displayedImage');
        displayedImage.src = image_url;
    }


    function fetchChartData(url, type) {
        const charbox = document.getElementById('charbox');
        charbox.innerHTML = '<canvas id="myChart01" width="1150" height="270"></canvas>';

        fetch(url)
            .then(response => response.json())
            .then(data => {
                let labels = [];
                let counts = [];

                if (type === 'weekly') {
                    const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                
                    labels = daysOfWeek;
                    counts = daysOfWeek.map(day => data.filter(item => new Date(item.Detection_Time).toLocaleDateString('en-US', { weekday: 'long' }) === day).length);
                }else if (type === 'daily') {
                    const today = new Date();
                    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                    const daysOfMonth = Array.from({ length: daysInMonth }, (_, i) => i + 1);
                    labels = daysOfMonth;
                    counts = daysOfMonth.map(day => data.filter(item => new Date(item.Detection_Time).getDate() === day).length);
                } else if (type === 'monthly') {
                    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                    labels = months;
                    counts = months.map(month => data.filter(item => new Date(item.Detection_Time).toLocaleDateString('en-US', { month: 'long' }) === month).length);
                } else if (type === 'yearly') {
                    const currentYear = new Date().getFullYear();
                    const years = Array.from({ length: currentYear - 2019 }, (_, i) => 2020 + i);
                    labels = years;
                    counts = years.map(year => data.filter(item => new Date(item.Detection_Time).getFullYear() === year).length);
                }

                const ctx = document.getElementById('myChart01').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '불량률 현황',
                            data: counts,
                            backgroundColor: 'rgba(0, 84, 255, 0.5)',
                            borderColor: 'rgba(0, 84, 255, 0.8)',
                            borderWidth: 3,
                            tension: 0.5 // 부드러운 곡선을 만들기 위해 장력을 설정합니다.
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error fetching chart data:', error));
    }
    document.getElementById('daylyBtn').addEventListener('click', () => fetchChartData('http://127.0.0.1:8000/test01day', 'daily'));
    document.getElementById('weeklyBtn').addEventListener('click', () => fetchChartData('http://127.0.0.1:8000/test01week', 'weekly'));
    document.getElementById('MonthlyBtn').addEventListener('click', () => fetchChartData('http://127.0.0.1:8000/test01month', 'monthly'));
    document.getElementById('yearlyBtn').addEventListener('click', () => fetchChartData('http://127.0.0.1:8000/test01year', 'yearly'));

    fetchChartData('http://127.0.0.1:8000/test01week', 'weekly');
 
    //이정은 버튼 스타일
    let chartBtn = document.querySelectorAll(".item02  button");

    chartBtn.forEach(button => {
    button.addEventListener('click', () => {
        chartBtn.forEach(btn => {
        btn.classList.remove('btn-dark');
        btn.classList.add('btn-light');
        });

        button.classList.remove('btn-light');
        button.classList.add('btn-dark');
    });
    });
// Initialize the chart variable to null
window.myChart02 = null;

function updateDoughnutChart() {
    fetch('http://127.0.0.1:8000/get_daily_classification_counts/')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            console.log('Data fetched for chart:', data);  // Debugging: Log the fetched data

            // Check if the data is in the expected format
            if (data && data.chart_data && data.chart_data.defective !== undefined && data.chart_data.normal !== undefined) {
                const ctx = document.getElementById('myChart02').getContext('2d');
                
                // Destroy the existing chart instance if it exists and is a Chart.js instance
                if (window.myChart02 instanceof Chart) {
                    window.myChart02.destroy();
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear the canvas
                }

                // Create a new Chart.js instance
                window.myChart02 = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['불량', '정상'],
                        datasets: [{
                            label: 'Quality Ratio',
                            data: [data.chart_data.defective, data.chart_data.normal],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)', // Color for '불량'
                                'rgba(75, 192, 192, 0.2)'  // Color for '정상'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',   // Border color for '불량'
                                'rgba(75, 192, 192, 1)'    // Border color for '정상'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: '불량 vs 정상 비율'
                            }
                        }
                    }
                });
            } else {
                console.error('Data format is incorrect or missing required fields:', data);
            }
        })
        .catch(error => console.error('Error fetching or rendering the doughnut chart:', error));
}

// Ensure that the chart update function is called when the page loads
document.addEventListener('DOMContentLoaded', (event) => {
    updateDoughnutChart();
    setInterval(updateDoughnutChart, 10000);  // Update every 10 seconds
});



  
</script>
{% endblock %}
